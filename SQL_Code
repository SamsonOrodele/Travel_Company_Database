-- Drop existing tables with all constraints and purge them from recycle bin
DROP TABLE EMP CASCADE CONSTRAINTS PURGE;
DROP TABLE VEHICLE CASCADE CONSTRAINTS PURGE;
DROP TABLE TICKET CASCADE CONSTRAINTS PURGE;
DROP TABLE SCHEDULE CASCADE CONSTRAINTS PURGE;
DROP TABLE AGENT CASCADE CONSTRAINTS PURGE;
DROP TABLE SALES_LIST CASCADE CONSTRAINTS PURGE;
DROP TABLE STOP CASCADE CONSTRAINTS PURGE;
DROP TABLE MEAL CASCADE CONSTRAINTS PURGE;
DROP TABLE CITY CASCADE CONSTRAINTS PURGE;
DROP TABLE ROUTE CASCADE CONSTRAINTS PURGE;

-- Set verification settings
SET VERIFY ON 
SET VERIFY OFF

-- Create EMP table for employee information
CREATE TABLE EMP (
    EMP_ID CHAR(5)
        CONSTRAINT PKEY_EMP PRIMARY KEY,            -- Primary key for employee
    First_name VARCHAR(10)
        CONSTRAINT FNAMEE NOT NULL,                 -- First name, required
    Middle_name VARCHAR(20)
        CONSTRAINT MNAME NULL,                      -- Middle name, optional
    Last_name VARCHAR(20)
        CONSTRAINT LNAME NOT NULL,                  -- Last name, required
    Sex CHAR(1)
        CONSTRAINT GENDER CHECK (SEX IN ('M','F')), -- Gender, must be M or F
    Designation VARCHAR(20)
        CONSTRAINT ROLE NOT NULL,                   -- Job role, required
    Mob_no CHAR(11)
        CONSTRAINT UNIQ_Mob UNIQUE,                 -- Unique mobile number
    Mgr_Id CHAR(5)
        CONSTRAINT MANAGER REFERENCES EMP(EMP_ID)   -- Foreign key to manager's EMP_ID
);

-- Create CITY table for city information
CREATE TABLE CITY (
    CITY_CODE CHAR(2)
        CONSTRAINT PKEY_CITY PRIMARY KEY,           -- Primary key for city
    CITY_NAME VARCHAR(20)
        CONSTRAINT C_NAME UNIQUE                    -- Unique city name
);

-- Create ROUTE table for route information
CREATE TABLE ROUTE (
    ROUTE_ID CHAR(4)
        CONSTRAINT PKEY_ROUTE PRIMARY KEY,          -- Primary key for route
    ROUTE_DESCRIPTION VARCHAR(50)
        CONSTRAINT R_DESCR NOT NULL,                -- Route description, required
    START_CITY_CODE CHAR(2)
        CONSTRAINT S_CITY_FK REFERENCES CITY(CITY_CODE),  -- FK to starting city
    END_CITY_CODE CHAR(2)
        CONSTRAINT E_CITY_FK REFERENCES CITY(CITY_CODE)   -- FK to ending city
);

-- Create STOP table for stop information
CREATE TABLE STOP (
    STOP_ID CHAR(6)
        CONSTRAINT STOP PRIMARY KEY,                -- Primary key for stop
    ROUTE_ID CHAR(4)
        CONSTRAINT ROUTE_FK REFERENCES ROUTE(ROUTE_ID), -- FK to route
    STOP_NAME VARCHAR(30),                         -- Name of the stop
    CITY_CODE CHAR(2)
        CONSTRAINT CITY_FK REFERENCES CITY(CITY_CODE)   -- FK to city
);

-- Create AGENT table for agent information
CREATE TABLE AGENT (
    AGENT_ID CHAR(5)
        CONSTRAINT PKEY_AGENT PRIMARY KEY,          -- Primary key for agent
    AGENCY_NAME VARCHAR(20)
        CONSTRAINT AG_NAME NOT NULL,                -- Agency name, required
    EMAIL VARCHAR(30)
        CONSTRAINT AG_MAIL UNIQUE,                  -- Unique email address
    PHONE_NO CHAR(11)
        CONSTRAINT AG_PH UNIQUE                     -- Unique phone number
);

-- Create MEAL table for meal information
CREATE TABLE MEAL (
    MEAL_NAME VARCHAR(30)
        CONSTRAINT PKEY_MEAL PRIMARY KEY,           -- Primary key for meal
    ROUTE_ID CHAR(4)
        CONSTRAINT ROUTM_FK REFERENCES ROUTE(ROUTE_ID), -- FK to route
    CITY_CODE CHAR(2)
        CONSTRAINT CITYM_FK REFERENCES CITY(CITY_CODE), -- FK to city
    STOP_ID CHAR(6)
        CONSTRAINT STOPM_FK REFERENCES STOP(STOP_ID)    -- FK to stop
);

-- Create SALES_LIST table for sales records
CREATE TABLE SALES_LIST (
    S_LIST_NO CHAR(5)
        CONSTRAINT PK_SALES PRIMARY KEY,            -- Primary key for sales list
    QTY_OF_TICKET_SOLD NUMBER,                     -- Number of tickets sold
    TRANS_DATE DATE,                               -- Transaction date
    AGENT_ID CHAR(5)
        CONSTRAINT AGT_FK REFERENCES AGENT(AGENT_ID) -- FK to agent
);

-- Create VEHICLE table for vehicle information
CREATE TABLE VEHICLE (
    VEHICLE_ID CHAR(5)
        CONSTRAINT PKEY_V PRIMARY KEY,              -- Primary key for vehicle
    S_CAP NUMBER(3)
        CONSTRAINT SEAT NOT NULL,                   -- Seating capacity, required
    MANUF VARCHAR(20)
        CONSTRAINT V_MAKE NOT NULL,                 -- Manufacturer, required
    REG_NO CHAR(7)
        CONSTRAINT CAR_REG UNIQUE                   -- Unique registration number
);

-- Create SCHEDULE table for schedule information
CREATE TABLE SCHEDULE (
    SCHEDULE_ID CHAR(5)
        CONSTRAINT PKEY_SCH PRIMARY KEY,            -- Primary key for schedule
    DEP_TIME VARCHAR(10) NOT NULL,                 -- Departure time, required
    DEP_DATE DATE
        CONSTRAINT DEPP CHECK(TO_CHAR(DEP_DATE, 'YYYY-MM-DD') >= '2022-01-01'), -- Date check
    NO_OF_SEAT_LEFT NUMBER
        CONSTRAINT SEATL CHECK(NO_OF_SEAT_LEFT <100), -- Seats left must be < 100
    TICKET_PRICE NUMBER
        CONSTRAINT TPRICE CHECK(TICKET_PRICE > 10), -- Price must be > 10
    ROUTE_ID CHAR(4)
        CONSTRAINT ROUTS_FK REFERENCES ROUTE(ROUTE_ID), -- FK to route
    VEHICLE_ID CHAR(5)
        CONSTRAINT VCL_FK REFERENCES VEHICLE(VEHICLE_ID) -- FK to vehicle
);

-- Create TICKET table for ticket information
CREATE TABLE TICKET (
    ticket_code CHAR(5)
        CONSTRAINT PKEY_TKT PRIMARY KEY,            -- Primary key for ticket
    SCHEDULE_ID CHAR(5)
        CONSTRAINT SC_FK REFERENCES SCHEDULE(SCHEDULE_ID), -- FK to schedule
    AGENT_ID CHAR(5)
        CONSTRAINT AGTK_FK REFERENCES AGENT(AGENT_ID), -- FK to agent
    S_LIST_NO CHAR(5)
        CONSTRAINT SNO REFERENCES SALES_LIST(S_LIST_NO) -- FK to sales list
);

-- Insert employee records into EMP table
INSERT INTO EMP VALUES ('TNM22', 'NEVILLE', 'JAMES', 'GALDWILDE', 'M', 'MANAGER', '07532246955', '');
INSERT INTO EMP VALUES ('TNM27', 'HERMIONE', 'RACHEL', 'GREY', 'F', 'MANAGER', '07832215694', 'TNM22');
INSERT INTO EMP VALUES ('TNC48', 'CHO', '', 'CHANG', 'F', 'CLERK', '07856311217', 'TNM27');
INSERT INTO EMP VALUES ('TNC42', 'RONALD', 'MASON', 'LONGBOTTOM', 'M', 'CLERK', '07821146688', 'TNM27');
INSERT INTO EMP VALUES ('TND65', 'FRANK', 'OLIVER', 'RUTT', 'M', 'DRIVER', '07812232621', 'TNM22');
INSERT INTO EMP VALUES ('TND68', 'SINAN', '', 'NIGLASTIC', 'M', 'DRIVER', '07963321771', 'TNM22');
INSERT INTO EMP VALUES ('TNC69', 'CHRISTIAN', 'ARNOLD', 'ROBBINSON', 'M', 'DRIVER', '07832211451', 'TNM22');
INSERT INTO EMP VALUES ('TND74', 'DAVE', 'JAMES', 'FISHER', 'M', 'DRIVER', '07863321189', 'TNM22');
INSERT INTO EMP VALUES ('TND81', 'LANCE', 'LIAM', 'GRAHAM', 'M', 'DRIVER', '07866232115', 'TNM22');
INSERT INTO EMP VALUES ('TNH83', 'MONICA', 'CHARLOTTE', 'LONG', 'F', 'HOUSEKEEPER', '07863312165', 'TNM27');

-- Insert city records into CITY table
INSERT INTO CITY VALUES('NE', 'NEWCASTLE');
INSERT INTO CITY VALUES('LH', 'LITTLE HANGLETON');
INSERT INTO CITY VALUES('LC', 'LEAKY CAULDRON');
INSERT INTO CITY VALUES('WD', 'WINDEMERE');
INSERT INTO CITY VALUES('DS', 'DURMSTRANG');
INSERT INTO CITY VALUES('BX', 'BEAUXBATONS');
INSERT INTO CITY VALUES('HG', 'HOGWARTS');
INSERT INTO CITY VALUES('HM', 'HOGSMEADE');
INSERT INTO CITY VALUES('CB', 'CLODBURY');
INSERT INTO CITY VALUES('CD', 'CHUDLEY');

-- Insert route records into ROUTE table
INSERT INTO ROUTE VALUES('NEWD', 'NEWCASTLE TO WINDEMERE', 'NE', 'WD');
INSERT INTO ROUTE VALUES('LHBX', 'LITTLE HANGLETON TO BEAUXBATONS', 'LH', 'BX');
INSERT INTO ROUTE VALUES('LCHG', 'LEAKY CAULDRON TO HOGWARTS VIA DURMSTRANG', 'LC', 'HG');
INSERT INTO ROUTE VALUES('WDHM', 'WINDEMERE TO HOGSMEADE', 'WD', 'HM');
INSERT INTO ROUTE VALUES('DSCB', 'DURMSTRANG TO CLODBURY', 'DS', 'CB');
INSERT INTO ROUTE VALUES('BXCD', 'BEAUXBATONS TO CHUDLEY', 'BX', 'CD');
INSERT INTO ROUTE VALUES('HGNE', 'HOGWARTS  TO  NEWCASTLE', 'HG', 'NE');
INSERT INTO ROUTE VALUES('HMLH', 'HOGSMEADE TO LITTLE HANGLETON', 'HM', 'LH');
INSERT INTO ROUTE VALUES('CBLC', 'CLODBURY TO LEAKY CAULDRON', 'CB', 'LC');
INSERT INTO ROUTE VALUES('CDWD', 'CHUDLEY TO DURMSTRANG', 'CD', 'WD');

-- Insert stop records into STOP table
INSERT INTO STOP VALUES('NEWD04', 'NEWD', 'LITTLE WHINNING', 'WD');
INSERT INTO STOP VALUES('NEWD11', 'NEWD', 'BURROWS HALL', 'WD');
INSERT INTO STOP VALUES('LHBX08', 'LHBX', 'MATHESON PLACE', 'BX');
INSERT INTO STOP VALUES('LHBX05', 'LHBX', 'APPLEYARD', 'BX');
INSERT INTO STOP VALUES('LCHG04', 'LCHG', 'SPINNERS END', 'DS');
INSERT INTO STOP VALUES('LCHG01', 'LCHG', 'SEVERUS PLACE', 'HG');
INSERT INTO STOP VALUES('WDHM22', 'WDHM', 'VICTORIA ISLAND', 'HM');
INSERT INTO STOP VALUES('WDHM20', 'WDHM', 'PRINCE MANOR', 'HM');
INSERT INTO STOP VALUES('DSCB21', 'DSCB', 'LABURN GARDEN', 'CB');
INSERT INTO STOP VALUES('DSCB18', 'DSCB', 'LOVEGOOD HOUSE', 'CB');

-- Insert agent records into AGENT table
INSERT INTO AGENT VALUES('TNA08', 'SPENCER JONES', 'info@spencerjones.co.uk', '07900221145');
INSERT INTO AGENT VALUES('TNA22', 'SOLOMONS LTD', 'enquiries@solommons.org', '07322144789');
INSERT INTO AGENT VALUES('TNA12', 'ASPIRE', 'enquiries@aspireteam.org', '07822145633');
INSERT INTO AGENT VALUES('TNA28', 'JAMES HARROW', 'help@jharrowinc.org', '07863112321');
INSERT INTO AGENT VALUES('TNA19', 'EMMANUEL ABBEY', 'contactus@abbeycity.co.uk', '07200132521');
INSERT INTO AGENT VALUES('TNA20', 'JANE JONES', 'info@janejones.org', '07933636221');
INSERT INTO AGENT VALUES('TNA11', 'LIZ BENSON', 'info@elizabethben.org', '07120203997');
INSERT INTO AGENT VALUES('TNA03', 'HARRY SONG', 'contact@harrysong.co.uk', '07288844632');
INSERT INTO AGENT VALUES('TNA84', 'BASKETMOUTH', 'info@basketmouthinc.org', '07789363213');
INSERT INTO AGENT VALUES('YNA90', 'PETER  BOOTS', 'help@peterboots.org', '07789332152');

-- Insert meal records into MEAL table
INSERT INTO MEAL VALUES('FISH AND CHIPS', 'LHBX', 'BX', 'LHBX08');
INSERT INTO MEAL VALUES('BANGERS AND MASH', 'LCHG', 'HG', 'LCHG01');
INSERT INTO MEAL VALUES('SUNDAY ROAST', 'DSCB', 'CB', 'DSCB21');
INSERT INTO MEAL VALUES('TOAD IN AHOLE', 'LCHG', 'HG', 'LCHG04');
INSERT INTO MEAL VALUES('SHEPHERD PIE', 'DSCB', 'CB', 'DSCB18');
INSERT INTO MEAL VALUES('STEAK AND KIDNEY', 'NEWD', 'WD', 'NEWD11');
INSERT INTO MEAL VALUES('ETON MESS', 'LHBX', 'BX', 'LHBX08');
INSERT INTO MEAL VALUES('CORNISH PASTY', 'WDHM', 'HM', 'WDHM22');
INSERT INTO MEAL VALUES('BEEF WELLINGTON', 'WDHM', 'HM', 'WDHM20');
INSERT INTO MEAL VALUES('BLACK PUDDING', 'LCHG', 'HG', 'LCHG01');

-- Insert sales list records into SALES_LIST table
INSERT INTO SALES_LIST VALUES('SL112', 232, TO_DATE('12-OCT-2022', 'DD-MM-YYYY'), 'TNA28');
INSERT INTO SALES_LIST VALUES('SL011', 412, TO_DATE('18-OCT-2022', 'DD-MM-YYYY'), 'TNA11');
INSERT INTO SALES_LIST VALUES('SL122', 288, TO_DATE('19-NOV-2022', 'DD-MM-YYYY'), 'TNA12');
INSERT INTO SALES_LIST VALUES('SL221', 302, TO_DATE('12-OCT-2022', 'DD-MM-YYYY'), 'TNA20');
INSERT INTO SALES_LIST VALUES('SL101', 96, TO_DATE('27-OCT-2022', 'DD-MM-YYYY'), 'TNA19');
INSERT INTO SALES_LIST VALUES('SL008', 163, TO_DATE('27-OCT-2022', 'DD-MM-YYYY'), 'TNA84');
INSERT INTO SALES_LIST VALUES('SL093', 125, TO_DATE('27-OCT-2022', 'DD-MM-YYYY'), 'TNA11');
INSERT INTO SALES_LIST VALUES('SL012', 44, TO_DATE('18-OCT-2022', 'DD-MM-YYYY'), 'TNA84');
INSERT INTO SALES_LIST VALUES('SL244', 288, TO_DATE('14-OCT-2022', 'DD-MM-YYYY'), 'TNA20');
INSERT INTO SALES_LIST VALUES('SL111', 429, TO_DATE('12-NOV-2022', 'DD-MM-YYYY'), 'TNA28');

-- Insert vehicle records into VEHICLE table
INSERT INTO VEHICLE VALUES('TN008', '81', 'ADL', 'HG26DHD');
INSERT INTO VEHICLE VALUES('TN023', '65', 'Monaco', 'DS31MWI');
INSERT INTO VEHICLE VALUES('TN314', '48', 'Swift ', 'CD10MDS');
INSERT INTO VEHICLE VALUES('TN172', '65', 'Monaco', 'BX08WQM');
INSERT INTO VEHICLE VALUES('TN209', '50', 'ADL', 'CB25JJK');
INSERT INTO VEHICLE VALUES('TN027', '62', 'EVM', 'DS11KAL');
INSERT INTO VEHICLE VALUES('TN068', '55', 'EVM', 'LH12WOI');
INSERT INTO VEHICLE VALUES('TN074', '48', 'GM Mini Bus', 'CD27YAN');
INSERT INTO VEHICLE VALUES('TN063', '81', 'Swift', 'NE19EPA');
INSERT INTO VEHICLE VALUES('TN042', '36', 'GM Mini Bus', 'LC13YEH');

-- Insert schedule records into SCHEDULE table
INSERT INTO SCHEDULE VALUES('TS132', TO_DATE('14:00:00', 'HH24:MI SS'), TO_DATE('2022-11-28', 'YYYY-MM-DD'), 6, 28, 'NEWD', 'TN008');
INSERT INTO SCHEDULE VALUES('TS155', TO_DATE('10:00:00', 'HH24:MI SS'), TO_DATE('2022-12-15', 'YYYY-MM-DD'), 22, 30, 'WDHM', 'TN042');
INSERT INTO SCHEDULE VALUES('SC147', TO_DATE('11:00:00', 'HH24:MI SS'), TO_DATE('2022-12-23', 'YYYY-MM-DD'), 8, 22.50, 'CBLC', 'TN063');
INSERT INTO SCHEDULE VALUES('TS007', TO_DATE('20:00:00', 'HH24:MI SS'), TO_DATE('2022-11-26', 'YYYY-MM-DD'), 3, 31.80, 'LHBX', 'TN068');
INSERT INTO SCHEDULE VALUES('TS099', TO_DATE('08:00:00', 'HH24:MI SS'), TO_DATE('2022-11-17', 'YYYY-MM-DD'), 4, 17.75, 'BXCD', 'TN027');
INSERT INTO SCHEDULE VALUES('TS102', TO_DATE('09:30:00', 'HH24:MI SS'), TO_DATE('2022-11-30', 'YYYY-MM-DD'), 0, 12.80, 'LCHG', 'TN209');
INSERT INTO SCHEDULE VALUES('SC821', TO_DATE('16:55:00', 'HH24:MI SS'), TO_DATE('2022-11-29', 'YYYY-MM-DD'), 11, 15.60, 'NEWD', 'TN172');
INSERT INTO SCHEDULE VALUES('SC120', TO_DATE('14:45:00', 'HH24:MI SS'), TO_DATE('2022-11-29', 'YYYY-MM-DD'), 18, 65, 'WDHM', 'TN314');
INSERT INTO SCHEDULE VALUES('TS029', TO_DATE('10:15:00', 'HH24:MI SS'), TO_DATE('2022-11-27', 'YYYY-MM-DD'), 10, 45, 'NEWD', 'TN027');
INSERT INTO SCHEDULE VALUES('SC077', TO_DATE('13:00:00', 'HH24:MI SS'), TO_DATE('2022-12-22', 'YYYY-MM-DD'), 2, 28, 'LHBX', 'TN023');

-- Insert ticket records into TICKET table
INSERT INTO TICKET VALUES('XC221', 'SC077', 'TNA08', 'SL221');
INSERT INTO TICKET VALUES('RE132', 'TS029', 'TNA22', 'SL101');
INSERT INTO TICKET VALUES('PD012', 'SC120', 'TNA12', 'SL244');
INSERT INTO TICKET VALUES('XC109', 'SC821', 'TNA28', 'SL111');
INSERT INTO TICKET VALUES('PD002', 'TS102', 'TNA19', 'SL221');
INSERT INTO TICKET VALUES('PX103', 'TS099', 'TNA20', 'SL008');
INSERT INTO TICKET VALUES('JJ190', 'TS007', 'TNA11', 'SL112');
INSERT INTO TICKET VALUES('ED112', 'SC147', 'TNA03', 'SL221');
INSERT INTO TICKET VALUES('PO120', 'SC120', 'TNA08', 'SL244');
INSERT INTO TICKET VALUES('WS155', 'TS155', 'TNA12', 'SL101');

-- Query schedules for NEWD route with available seats between specific dates
SELECT SCHEDULE_ID, 
       DEP_DATE, 
       NO_OF_SEAT_LEFT, 
       ROUTE_DESCRIPTION, 
       TICKET_PRICE, 
       ROUTE_ID, 
       VEHICLE_ID
FROM SCHEDULE
JOIN ROUTE USING(ROUTE_ID)
WHERE NO_OF_SEAT_LEFT > 5 
    AND DEP_DATE >= TO_DATE('2022-11-21', 'YYYY-MM-DD') 
    AND DEP_DATE <= TO_DATE('2022-11-30', 'YYYY-MM-DD')
    AND ROUTE_ID = 'NEWD'
ORDER BY DEP_DATE ASC;

-- Query top agent by ticket sales in October 2022 (using FETCH FIRST)
SELECT AGENT_ID, 
       AGENCY_NAME, 
       SUM(QTY_OF_TICKET_SOLD) AS HIGHEST_TICKETS_SOLD
FROM SALES_LIST
JOIN AGENT USING (AGENT_ID)
WHERE TRANS_DATE >= TO_DATE('01-10-2022', 'DD/MM/YYYY') 
    AND TRANS_DATE <= TO_DATE('31-10-2022','DD/MM/YYYY')
GROUP BY AGENT_ID, AGENCY_NAME
ORDER BY HIGHEST_TICKETS_SOLD DESC
FETCH FIRST 1 ROWS ONLY;

-- Query top agent by ticket sales in October 2022 (using ROWNUM)
SELECT * 
FROM (
    SELECT AGENT_ID, 
           AGENCY_NAME, 
           SUM(QTY_OF_TICKET_SOLD) AS HIGHEST_TICKETS_SOLD
    FROM SALES_LIST
    JOIN AGENT USING (AGENT_ID)
    WHERE TRANS_DATE >= TO_DATE('01-10-2022', 'DD/MM/YYYY') 
        AND TRANS_DATE <= TO_DATE('31-10-2022','DD/MM/YYYY')
    GROUP BY AGENT_ID, AGENCY_NAME
    ORDER BY HIGHEST_TICKETS_SOLD DESC
)
WHERE ROWNUM = 1;

-- Insert additional schedule record
INSERT INTO SCHEDULE VALUES(
    'SC077', 
    TO_DATE('13:00', 'HH24:MI'),
    TO_DATE('2022-03-22', 'YYYY-MM-DD'), 
    14, 
    28, 
    'LHBX', 
    'TN023'
);

-- Set date format for session
ALTER SESSION SET nls_date_format = 'YYYY-MM-DD HH24:MI:SS';

-- Insert more schedule records
INSERT INTO SCHEDULE VALUES('TS132', TO_DATE('14:00:00', 'HH24:MI SS'), TO_DATE('2022-11-18', 'YYYY-MM-DD'), 23, 28, 'NEWD', 'TN008');
INSERT INTO SCHEDULE VALUES('TS155', TO_DATE('10:00:00', 'HH24:MI SS'), TO_DATE('2022-04-22', 'YYYY-MM-DD'), 35, 30, 'WDHM', 'TN042');
INSERT INTO SCHEDULE VALUES('SC147', TO_DATE('11:00:00', 'HH24:MI SS'), TO_DATE('2022-03-23', 'YYYY-MM-DD'), 30, 22.50, 'CBLC', 'TN063');
INSERT INTO SCHEDULE VALUES('TS007', TO_DATE('20:00:00', 'HH24:MI SS'), TO_DATE('2022-03-13', 'YYYY-MM-DD'), 50, 31.80, 'LHBX', 'TN068');
INSERT INTO SCHEDULE VALUES('TS099', TO_DATE('08:00:00', 'HH24:MI SS'), TO_DATE('2022-03-17', 'YYYY-MM-DD'), 12, 17.75, 'BXCD', 'TN027');
INSERT INTO SCHEDULE VALUES('TS102', TO_DATE('09:30:00', 'HH24:MI SS'), TO_DATE('2022-03-10', 'YYYY-MM-DD'), 0, 12.80, 'LCHG', 'TN209');
INSERT INTO SCHEDULE VALUES('SC821', TO_DATE('16:55:00', 'HH24:MI SS'), TO_DATE('2022-03-05', 'YYYY-MM-DD'), 11, 15.60, 'CDWD', 'TN172');
INSERT INTO SCHEDULE VALUES('SC120', TO_DATE('14:45:00', 'HH24:MI SS'), TO_DATE('2022-03-30', 'YYYY-MM-DD'), 1, 65, 'WDHM', 'TN314');
INSERT INTO SCHEDULE VALUES('TS029', TO_DATE('10:15:00', 'HH24:MI SS'), TO_DATE('2022-03-03', 'YYYY-MM-DD'), 13, 45, 'DSCB', 'TN027');
INSERT INTO SCHEDULE VALUES('SC077', TO_DATE('13:00:00', 'HH24:MI SS'), TO_DATE('2022-03-22', 'YYYY-MM-DD'), 14, 28, 'LHBX', 'TN023');

-- Query schedules for NEWD route with available seats between specific dates
SELECT SCHEDULE_ID, 
       DEP_DATE, 
       NO_OF_SEAT_LEFT, 
       TICKET_PRICE, 
       ROUTE_ID, 
       VEHICLE_ID
FROM SCHEDULE
JOIN ROUTE USING(ROUTE_ID)
WHERE NO_OF_SEAT_LEFT > 5 
    AND DEP_DATE BETWEEN '2022-11-22' AND '2022-12-22'
    AND ROUTE_ID = 'NEWD'
ORDER BY DEP_DATE ASC;

-- Drop and recreate SCHEDULE table with modified structure
DROP TABLE SCHEDULE CASCADE CONSTRAINTS PURGE;

CREATE TABLE SCHEDULE (
    SCHEDULE_ID CHAR(5)
        CONSTRAINT PKEY_SCH PRIMARY KEY,            -- Primary key for schedule
    DEP_DATE DATE NOT NULL,                        -- Departure date, required
    NO_OF_SEAT_LEFT NUMBER
        CONSTRAINT SEATL CHECK(NO_OF_SEAT_LEFT <100), -- Seats left must be < 100
    TICKET_PRICE NUMBER
        CONSTRAINT TPRICE CHECK(TICKET_PRICE > 10), -- Price must be > 10
    ROUTE_ID CHAR(4)
        CONSTRAINT ROUTS_FK REFERENCES ROUTE(ROUTE_ID), -- FK to route
    VEHICLE_ID CHAR(5)
        CONSTRAINT VCL_FK REFERENCES VEHICLE(VEHICLE_ID) -- FK to vehicle
);

-- Insert schedule record with full timestamp
INSERT INTO SCHEDULE VALUES(
    'TS132', 
    TO_DATE('2022-11-18 14:00:00', 'YYYY-MM-DD HH24:MI SS'), 
    23, 
    28, 
    'NEWD', 
    'TN008'
);

-- Set output line size
SET LINESIZE 500;
